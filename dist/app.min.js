angular.module('app').config(configRoute);

/* ngInject */
function configRoute($stateProvider, $locationProvider, $urlRouterProvider) {
    $locationProvider.html5Mode(false);

    $urlRouterProvider
        .when('/', '/daily')
        .otherwise('/daily');

    $stateProvider
        .state('main', {
            url: '/',
            templateUrl: 'main.html',
            controller: 'MainCtrl',
            controllerAs: 'main',
        })
        .state('main.map', {
            url: '^/map',
            templateUrl: 'map.html',
            controller: 'MainCtrl',
            controllerAs: 'main',
        })
        .state('main.point', {
            url: '^/point/:area/:tit',
            templateUrl: 'Europe.html',
            controller: 'MainDrawCtrl',
            controllerAs: 'fdc',       
        })
        // .state('main.Asia', {
        //     url: '^/Asia/:area',
        //     templateUrl: 'Asia.html'
        // })
        // .state('main.Africa', {
        //     url: '^/Africa/:area',
        //     templateUrl: 'Africa.html'
        // })
        // .state('main.America', {
        //     url: '^/America/:area',
        //     templateUrl: 'America.html'
        // })
        // .state('main.Anzac', {
        //     url: '^/Anzac/:area',
        //     templateUrl: 'Anzac.html',
        // })
        // .state('main.Pacific', {
        //     url: '^/Pacific/:area',
        //     templateUrl: 'Pacific.html',
        // })
        .state('main.daily', {
            url: '^/daily',
            templateUrl: 'daily.html',
            controller: 'DailyCtrl',
            controllerAs: 'dc'
        })
        .state('main.pit_detail', {
            url: '^/pit_detail/:pit_name/:pit_img',
            templateUrl: 'pit_detail.html',
            controller: 'PitDetailCtrl',
            controllerAs: 'pdc'
        })
        .state('main.game', {
            url: '^/game',
            templateUrl: 'game.html'
        })
        .state('main.puzzle', {
            url: '^/puzzle',
            templateUrl: 'puzzle.html',
            controller: 'PuzzleCtrl',
            controllerAs: 'puc',
        })
        .state('main.question', {
            url: '^/question',
            templateUrl: 'question_ans.html',
            controller: 'QuestionCtrl',
            controllerAs: 'qc',
        })
        .state('main.zhaoca', {
            url: '^/zhaoca',
            templateUrl: 'zhaoca.html',
            controller: 'GameCtrl',
            controllerAs: 'gc',
        })
        .state('main.paint', {
            url: '^/paint',
            templateUrl: 'paint.html'
        })
        .state('main.create', {
            url: '^/create',
            templateUrl: 'create.html',
            controller: 'PaintBoardCtrl',
            controllerAs: 'pbc',
        })
        .state('main.linmo', {
            url: '^/linmo',
            templateUrl: 'linmo.html',
            controller: 'LinmoCtrl',
            controllerAs: 'lc',
        })
        .state('main.addcolor', {
            url: '^/addcolor',
            templateUrl: 'addcolor.html',
            controller: 'PaintBoardCtrl',
            controllerAs: 'pbc'
        })
        .state('main.my', {
            url: '^/my',
            templateUrl: 'my.html',
            controller: 'Myctrl',
            controllerAs: 'mc',
        })
        .state('main.mycollect', {
            url: '^/mycollect',
            templateUrl: 'mycollect.html',
            controller: 'MyCollectCtrl',
            controllerAs: 'mcc',
        })
        .state('main.mydraw', {
            url: '^/mydraw',
            templateUrl: 'mydraw.html',
            controller: 'MyDrawCtrl',
            controllerAs: 'mdc',
        })
        .state('main.mypit', {
            url: '^/mypit',
            templateUrl: 'mypitrue.html',
            controller: 'MyPitCtrl',
            controllerAs: 'mpc',
        })

}
(function() {
    angular.module('app').controller('DailyCtrl', DailyCtrl);

    // 全局控制器 
    /* ngInject */
    function DailyCtrl($rootScope, $window, $scope, $http, $state) {
        var ctrl = {
            imgData: null,
            dailyArr: [{
                id:1,
                painting_name:"星夜",
                painting_url:"./imgs/dailypit/xingye.jpg",
                pit_img:"./imgs/dailypit/eur1.jpg"
            },{
                id:2,
                painting_name:"星夜",
                painting_url:"./imgs/dailypit/xingye.jpg",     
                pit_img:"./imgs/dailypit/eur1.jpg"           
            }],
            dailypit:{},
            dailydb: null,
            date: null,
            musicShow: false,
            mShow: mShow
        };
        (function() {
            initPit();
            var back = document.getElementById('backMap');
            if (document.body.ontouchstart !== undefined) {
                back.ontouchstart = function() {
                    $state.go('main.map');
                }
            } else {
                back.onclick = function() {
                    $state.go('main.map');
                }
            }
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function initPit() {
            var myDate = new Date();
            var day = myDate.getDate();
            var id = 1;
            if (day % 2 == 0) {
                ctrl.dailypit=ctrl.dailyArr[0];
            } else { 
                ctrl.dailypit=ctrl.dailyArr[1];
            }
        }
        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('GameCtrl', GameCtrl);

    // 全局控制器 
    /* ngInject */
    function GameCtrl($rootScope, $scope, $state, $http, $timeout, ngDialog, BackService) {
        var ctrl = {
            imgObj: null,
            musicShow: false,
            mShow: mShow,
            zhaochaBg: zhaochaBg,
            zc_id: 0,
            zc_pit: [],
            pointA: { icheck: false },
            pointB: { icheck: false },
            pointC: { icheck: false },
            pointD: { icheck: false },
            pointE: { icheck: false }
        };
        (function() {
            zhaochaBg();
            $rootScope.tipShow = true;
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }
        var lcanvas = document.getElementById('lcanvas');
        var lctx = lcanvas.getContext("2d");
        // var limg = new Image();

        var rcanvas = document.getElementById('rcanvas');
        var rctx = rcanvas.getContext("2d");
        // var rimg = new Image();

        function zhaochaBg() {
            var lcanvas = document.getElementById('lcanvas');
            var lctx = lcanvas.getContext("2d");            
            lctx.clearRect(0,0,lcanvas.width,lcanvas.height);
            var rcanvas = document.getElementById('rcanvas');
            var rctx = rcanvas.getContext("2d");            
            rctx.clearRect(0,0,rcanvas.width,rcanvas.height);

            $rootScope.tipShohw = true;
            ctrl.zc_id = ctrl.zc_id + 1;
            if (ctrl.zc_id == 3) {
                ctrl.zc_id = 1;
            }
            var imgId = ctrl.zc_id; /*parseInt(Math.random()*3+1)*/
            var imgObj = null;
            ctrl.pointA.icheck = false;
            ctrl.pointB.icheck = false;
            ctrl.pointC.icheck = false;
            ctrl.pointD.icheck = false;
            ctrl.pointE.icheck = false;

            $http
                .get('./data/zhaocha.xml')
                .success(function(data, status, headers, config) {
                    var element = angular.element(data.trim()).find('zhaocha');
                    for (var i = 0; i < element.length; i++) {

                        var product = element.eq(i);
                        var obj = {};
                        obj = {
                            limg: product.attr("limg"),
                            rimg: product.attr("rimg"),
                            first: product.attr("first"),
                            second: product.attr("second"),
                            third: product.attr("third"),
                            forth: product.attr("forth"),
                            five: product.attr("five")
                        };
                        ctrl.zc_pit[i] = obj;
                        
                    }
                    // if(ctrl.zc_pit[0].limg==undefined){
                    //     ctrl.zc_pit.splice(0,1);
                    // }
                    console.log(ctrl.zc_pit);
                    ctrl.imgObj = ctrl.zc_pit[imgId];


                    lcanvas.style.backgroundImage = "url(" + ctrl.imgObj.limg + ")";
                    rcanvas.style.backgroundImage = "url(" + ctrl.imgObj.rimg + ")";

                    var pointA = ctrl.imgObj.first.split(',');
                    var pointB = ctrl.imgObj.second.split(',');
                    var pointC = ctrl.imgObj.third.split(',');
                    var pointD = ctrl.imgObj.forth.split(',');
                    var pointE = ctrl.imgObj.five.split(',');


                    ctrl.pointA.lx = parseInt(pointA[0]);
                    ctrl.pointA.rx = parseInt(pointA[1]);
                    ctrl.pointA.ty = parseInt(pointA[2]);
                    ctrl.pointA.by = parseInt(pointA[3]);
                    ctrl.pointA.cx = parseInt(pointA[4]);
                    ctrl.pointA.cy = parseInt(pointA[5]);

                    ctrl.pointB.lx = parseInt(pointB[0]);
                    ctrl.pointB.rx = parseInt(pointB[1]);
                    ctrl.pointB.ty = parseInt(pointB[2]);
                    ctrl.pointB.by = parseInt(pointB[3]);
                    ctrl.pointB.cx = parseInt(pointB[4]);
                    ctrl.pointB.cy = parseInt(pointB[5]);

                    ctrl.pointC.lx = parseInt(pointC[0]);
                    ctrl.pointC.rx = parseInt(pointC[1]);
                    ctrl.pointC.ty = parseInt(pointC[2]);
                    ctrl.pointC.by = parseInt(pointC[3]);
                    ctrl.pointC.cx = parseInt(pointC[4]);
                    ctrl.pointC.cy = parseInt(pointC[5]);

                    ctrl.pointD.lx = parseInt(pointD[0]);
                    ctrl.pointD.rx = parseInt(pointD[1]);
                    ctrl.pointD.ty = parseInt(pointD[2]);
                    ctrl.pointD.by = parseInt(pointD[3]);
                    ctrl.pointD.cx = parseInt(pointD[4]);
                    ctrl.pointD.cy = parseInt(pointD[5]);

                    ctrl.pointE.lx = parseInt(pointE[0]);
                    ctrl.pointE.rx = parseInt(pointE[1]);
                    ctrl.pointE.ty = parseInt(pointE[2]);
                    ctrl.pointE.by = parseInt(pointE[3]);
                    ctrl.pointE.cx = parseInt(pointE[4]);
                    ctrl.pointE.cy = parseInt(pointE[5]);

                    checkSame(ctrl.pointA, ctrl.pointB, ctrl.pointC, ctrl.pointD, ctrl.pointE);
                })
                .error(function(data, status, headers, config) {});
            ngDialog.closeAll();
        }

        function drawCircle(ctx, x, y) {
            ctx.beginPath();
            ctx.strokeStyle = "red";
            ctx.lineWidth = 5;
            ctx.arc(x, y, 80, 0, Math.PI * 2, false);
            ctx.stroke();
        }

        function checkPoint(x, y, objA, objB, objC, objD, objE) {
            if ((x > objA.lx && x < objA.rx) && (y > objA.ty && y < objA.by)) {
                if (!objA.icheck) {
                    drawCircle(lctx, objA.cx, objA.cy);
                    drawCircle(rctx, objA.cx, objA.cy);
                    objA.icheck = true;
                }
            } else if ((x > objB.lx && x < objB.rx) && (y > objB.ty && y < objB.by)) {
                if (!objB.icheck) {
                    drawCircle(lctx, objB.cx, objB.cy);
                    drawCircle(rctx, objB.cx, objB.cy);
                    objB.icheck = true;
                }
            } else if ((x > objC.lx && x < objC.rx) && (y > objC.ty && y < objC.by)) {
                if (!objC.icheck) {
                    drawCircle(lctx, objC.cx, objC.cy);
                    drawCircle(rctx, objC.cx, objC.cy);
                    objC.icheck = true;
                }
            } else if ((x > objD.lx && x < objD.rx) && (y > objD.ty && y < objD.by)) {
                if (!objD.icheck) {
                    drawCircle(lctx, objD.cx, objD.cy);
                    drawCircle(rctx, objD.cx, objD.cy);
                    objD.icheck = true;
                }
            } else if ((x > objE.lx && x < objE.rx) && (y > objE.ty && y < objE.by)) {

                if (!objE.icheck) {
                    console.log(objE);
                    drawCircle(lctx, objE.cx, objE.cy);
                    drawCircle(rctx, objE.cx, objE.cy);
                    objE.icheck = true;
                }
            }
            if (objA.icheck && objB.icheck && objC.icheck && objD.icheck && objE.icheck) {
                $timeout(function() {              
                    if (ctrl.zc_id < 2) {
                        ngDialog.open({
                            template: 'zc_win.html',
                            className: 'ngdialog-theme-default ngdialog-theme-custom',
                            scope: $scope
                        });
                    } else if (ctrl.zc_id == 2) {
                        ngDialog.open({
                            template: 'zc_finsh.html',
                            className: 'ngdialog-theme-default ngdialog-theme-custom',
                            scope: $scope
                        });
                    }
                }, 500);
            }
        }

        function checkSame(objA, objB, objC, objD, objE) {
            if (document.body.ontouchstart !== undefined) {
                lcanvas.ontouchend = function() {
                    var x = e.touches[0].clientX - lcanvas.getBoundingClientRect().left;
                    var y = e.touches[0].clientY - lcanvas.getBoundingClientRect().top;
                    checkPoint(x, y, objA, objB, objC, objD, objE);
                };
                rcanvas.ontouchend = function() {
                    var x = e.touches[0].clientX - rcanvas.getBoundingClientRect().left;
                    var y = e.touches[0].clientY - rcanvas.getBoundingClientRect().top;
                    checkPoint(x, y, objA, objB, objC, objD, objE);
                };
            } else {
                // 非触屏设备
                lcanvas.onmousedown = function(e) {
                    var x = e.clientX - lcanvas.getBoundingClientRect().left;
                    var y = e.clientY - lcanvas.getBoundingClientRect().top;
                    checkPoint(x, y, objA, objB, objC, objD, objE);
                    console.log(x);
                    console.log(y);
                };
                rcanvas.onmousedown = function(e) {
                    var x = e.clientX - rcanvas.getBoundingClientRect().left;
                    var y = e.clientY - rcanvas.getBoundingClientRect().top;
                    checkPoint(x, y, objA, objB, objC, objD, objE);
                };
            }
        }

        return ctrl;
    }
})();
(function() {
    angular.module('app').controller('LinmoCtrl', LinmoCtrl);

    // 全局控制器 
    /* ngInject */
    function LinmoCtrl($rootScope, BackService,$scope, $state, $http) {
        var ctrl = {
            musicShow: false,
            lm_pit:[{
                imgData:'./imgs/dailypit/xingye.jpg',
                imgTitle:'./imgs/dailypit/xingye_tit.png'
            },
            {
                imgData:'./imgs/dailypit/xingye1.jpg',
                imgTitle:'./imgs/dailypit/xingye_tit.png'
            }],
            lm_showpit:{},
            mShow: mShow
        };

        (function() {
            linmoBg();
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }


        function linmoBg() {
            var imgId = 0;/*parseInt(Math.random() * 3 + 1)*/
            ctrl.lm_showpit=ctrl.lm_pit[imgId];
        }

        return ctrl;
    }
})();
(function() {
    angular.module('app').controller('MainCtrl', MainCtrl);

    // 全局控制器 
    /* ngInject */
    function MainCtrl($rootScope, $window, $scope, $http, $state, initService, DirectService) {
        var ctrl = {
            init_data: false,
            open_show: true,
            pointShow: false,
            lg_nav: true,
            mapP: [{
                point: "p_one",
                route: "main.Europe",
                area: "Europe",
                tit: './imgs/common/eurtit.png'
            }, {
                point: "p_two",
                route: "main.Asia",
                area: "Asia",
                tit: './imgs/common/eurtit.png'
            }, {
                point: "p_three",
                route: "main.Africa",
                area: "Africa",
                tit: './imgs/common/eurtit.png'
            }, {
                point: "p_four",
                route: "main.America",
                area: "America",
                tit: './imgs/common/eurtit.png'
            }, {
                point: "p_five",
                route: "main.Anzac",
                area: "Anzac",
                tit: './imgs/common/eurtit.png'
            }, {
                point: "p_six",
                route: "main.Pacific",
                area: "Pacific",
                tit: './imgs/common/eurtit.png'
            }],
            toBack: toBack,
            toMap: toMap,
            navShow: navShow,
            tipDel: tipDel,
            backGameMain: backGameMain
        };
        (function() {
            // initDB();
            // initMainDrawDB();
            if ($window.sessionStorage.myicon == undefined) {
                $rootScope.avatar = './imgs/common/myicon.png';
            } else {
                $rootScope.avatar = $window.sessionStorage.myicon;
            }

            $rootScope.tipShow = false;
            navSlide();
            window.onresize = function() {
                location.replace(document.referrer);
            };
        })();

        function tipDel() {
            $rootScope.tipShow = false;
        }

        function navShow() {
            $("#nav-bar").animate({ left: '0rem' });
        }

        function navSlide() {
            var startx, starty;

            var start = function(e) {
                if (!e.touches) {
                    startx = e.pageX;
                    starty = e.pageY;

                } else {
                    startx = e.touches[0].pageX;
                    starty = e.touches[0].pageY;
                }
            }
            var end = function(e) {
                var endx, endy;
                if (!e.touches) {
                    endx = e.pageX;
                    endy = e.pageY;

                } else {
                    endx = e.changedTouches[0].pageX;
                    endy = e.changedTouches[0].pageY;
                }

                var direction = DirectService.getDirection(startx, starty, endx, endy);
                switch (direction) {
                    case 3:
                        $("#nav-bar").animate({ left: '-3.2rem' });
                        break;
                    case 4:
                        $("#nav-bar").animate({ left: '0rem' });
                        break;
                    default:
                }
            }
            window.addEventListener("touchstart", start);
            window.addEventListener("mousedown", start);
            window.addEventListener("touchend", end);
            window.addEventListener("mouseup", end);
        }

        function toBack() {
            history.back();
        }

        function toMap() {
            $state.go('main.map');
        }

        function backGameMain() {
            $state.go('main.game');
        }


        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('MainDrawCtrl', MainDrawCtrl);

    // 全局控制器 
    /* ngInject */
    function MainDrawCtrl($rootScope, $stateParams, BackService, $window, $scope, $http, $state) {
        var ctrl = {
            main_pit: [],
            date: null,
            area: $stateParams.area,
            tit: $stateParams.tit,
            icheck: []
        };
        (function() {
            initPit();
            // initEPit();
            BackService.init();
        })();

        function initPit() {
            var obj = {};
            $http
                .get('./data/maindraw.xml')
                .success(function(data, status, headers, config) {
                    var element = angular.element(data.trim()).find(ctrl.area);
                    for (var i = 0; i < element.length; i++) {

                        var product = element.eq(i);

                        obj = {
                            painting_name: product.attr("painting_name"),
                            painting_img: product.attr("painting_img"),
                            piturl: product.attr("piturl")
                        };
                        ctrl.main_pit[i] = obj;
                    }
                    if (ctrl.main_pit[0].painting_name == undefined) {
                        ctrl.main_pit.splice(0, 1);
                    }
                    for (var j = 0; j < ctrl.main_pit.length; j++) {
                        checkPit(ctrl.main_pit[j].painting_name, j);
                    }
                })
                .error(function(data, status, headers, config) {});
        }

        function checkPit(pitname, j) {
            if ($window.sessionStorage.user != undefined) {
                var db = openDatabase('history', '1.0', 'test db', 1024 * 1024);
                db.transaction(function(tx) {
                    tx.executeSql('select * from history where name= ? and painting_name=?', [$window.sessionStorage.user, pitname], function(tx, results) {
                        $scope.$apply(function() {
                            if (results.rows.length == 0) {
                                ctrl.icheck[j] = false;
                            } else {
                                ctrl.icheck[j] = true;
                            }
                        });
                    });
                });
            }
        }
        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('MyCollectCtrl', MyCollectCtrl);

    // 全局控制器 
    /* ngInject */
    function MyCollectCtrl($rootScope, $window, $scope, $http, BackService, $state) {
        var ctrl = {
            date: null,
            collect_pit:[],
            collectdate:[],
            musicShow: false,
            mShow: mShow            
        };
        (function() {
            initCollect();
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }        

        function initCollect() {
            ctrl.collectdb = openDatabase('collect', '1.0', 'test db', 1024 * 1024);
            ctrl.collectdb.transaction(function(tx) {
                tx.executeSql('select * from collect where name= ?', [$window.sessionStorage.user], function(tx, results) {
                    if(results.rows.length==0){
                        document.getElementById('no-con').style.display="block";
                    }else{
                        document.getElementById('no-con').style.display="none";
                        $scope.$apply(function(){
                            var date = [];
                            for (var i = 0; i < results.rows.length; i++) {
                                ctrl.collect_pit.push(results.rows.item(i));
                                date[i] = ctrl.collect_pit[i].date;
                                if (date.indexOf(date[i]) != i) {
                                    date.splice(i, 1);
                                }
                            }
                            for (var j = 0; j < date.length; j++) {
                                datePit(date[j]);
                            }                            
                        });
                    }
                });
            });
        }

        function datePit(date) {
            var db = openDatabase('collect', '1.0', 'test db', 1024 * 1024);
            db.transaction(function(tx) {
                tx.executeSql('select * from collect where date= ?', [date], function(tx, results) {
                    $scope.$apply(function() {
                        var cdate = {};
                        cdate.date = date;
                        cdate.img=[];
                        for(var i = 0; i < results.rows.length; i++){
                            cdate.img[i] = results.rows.item(i);
                        }
                        ctrl.collectdate.push(cdate);
                        console.log(ctrl.collectdate);
                    });
                });
            });
        }        
        return ctrl;
    }
})();
(function() {
    angular.module('app').controller('Myctrl', Myctrl);

    // 全局控制器 
    /* ngInject */
    function Myctrl($rootScope, $window, $scope, $webSql, $http, $state, BackService, ngDialog) {
        var ctrl = {
            login_user: { username: '', password: '' },
            add_user: { username: '', password: '', private_que: '', private_ans: '' },
            code_user: { username: '', password: '', private_que: '', private_ans: '' },
            login: login,
            logout: logout,
            fileData: null,
            register: register,
            imgUpload: imgUpload,
            pitrueshow: false,
            resShow: false,
            findcode: false,
            sure_code: '',
            collect_pit: [],
            inpcode: '',
            code: '',
            db: null,
            updateCode: updateCode,
            resetCode: resetCode,
            textUpload: textUpload
        };
        (function() {
            BackService.init();
            var db;
            db = openDatabase('history', '1.0', 'test db', 1024 * 1024);
            db.transaction(function(tx) {
                tx.executeSql('CREATE TABLE IF NOT EXISTS history (id unique,name,painting_name,painting_img,date)');
            });            
            if (!ctrl.resShow) {
                updateCode();
            }

            initUserDB();
            inituser();
        })();

        return ctrl;

        function textUpload() {
            var text = document.getElementById('text').value;
            ctrl.db.transaction(function(tx) {
                tx.executeSql('UPDATE user SET saying=? WHERE name=?', [text, $window.sessionStorage.user], function(tx, results) {
                    console.log('更新成功！');
                    inituser();
                });
            });
        }

        function updateCode() {
            var yzcanvas = document.getElementById('yzcode');
            createCode();
            codeCanvas(yzcanvas);
        }

        function createCode() {
            ctrl.code = '';
            var codeLength = 4;
            var random = new Array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z');
            for (var i = 0; i < codeLength; i++) {
                var index = Math.floor(Math.random() * 62);
                ctrl.code += random[index];
            }
            return ctrl.code;
        }

        function lineX() {
            var ranLineX = Math.floor(Math.random() * 300);
            return ranLineX;
        }

        function lineY() {
            var ranLineY = Math.floor(Math.random() * 150);
            return ranLineY;
        }

        function codeCanvas(codeShow) {
            var cxt = codeShow.getContext('2d');
            //背景颜色
            cxt.fillStyle = '#8dd5e7';
            //矩形左上角x,y坐标以及矩形宽高
            cxt.fillRect(0, 0, 500, 200);
            //生成干扰线50条
            for (var j = 0; j < 50; j++) {
                //线条的颜色
                cxt.strokeStyle = '#666';
                //若省略beginPath，则每点击一次验证码会累积干扰线的条数
                cxt.beginPath();
                cxt.moveTo(lineX(), lineY());
                cxt.lineTo(lineX(), lineY());
                cxt.lineWidth = 2;
                cxt.closePath();
                cxt.stroke();
            }
            //不设置的话里面的文本颜色就是和上面设置的背景色相同
            cxt.fillStyle = '#ddd';
            cxt.font = 'bold 85px Arial';
            //把生成的随机数文本填充到canvas中
            cxt.fillText(createCode(), 20, 100);
        }

        function imgUpload() {
            var objFile = $('#imgupload').val();
            var files = $('#imgupload')[0].files[0];
            var fr = new FileReader();
            var user = $window.sessionStorage.user;
            fr.onload = function() {
                ctrl.upimg = this.result;
                ctrl.db.transaction(function(tx) {
                    tx.executeSql('UPDATE user SET myicon=? WHERE name=?', [ctrl.upimg, user], function(tx, results) {
                        console.log('更新成功！');
                        document.getElementById('imgId').src = this.result;
                        inituser();
                    });
                });
            };
            fr.readAsDataURL(files);
        }

        function initUserDB() {
            if (!window.openDatabase) {
                alert('当前环境不支持websql');
            } else {
                ctrl.db = openDatabase('users', '1.0', 'test db', 1024 * 1024);
                ctrl.db.transaction(function(context) {
                    context.executeSql('CREATE TABLE IF NOT EXISTS user (name unique,password,question,answer,saying,myicon)');
                    context.executeSql('INSERT INTO user (name,password,question,answer,saying,myicon) VALUES ("chen", "123","wo","wo","I am chen","./imgs/myicon/myicon.png")');
                    context.executeSql('INSERT INTO user (name,password,question,answer,saying,myicon) VALUES ("可", "123","wo","wo","I am 可","./imgs/myicon/myicon.png")');
                });
            };
        }

        function login() {
            if (!ctrl.login_user.username || !ctrl.login_user.password) {
                openDialog('用户名或密码未填写');
            } else {
                ctrl.db.transaction(function(tx) {
                    tx.executeSql('select * from user where name= ?', [ctrl.login_user.username], function(tx, results) {
                        if (results.rows.length == 0) {
                            openDialog('用户不存在，请先注册！');
                        } else {
                            if (results.rows.item(0).password != ctrl.login_user.password) {
                                openDialog('用户或密码错误！');
                            } else {
                                $scope.$apply(function() {
                                    $window.sessionStorage.setItem("user", ctrl.login_user.username);
                                    document.getElementById('imgId').src = results.rows.item(0).myicon;
                                    document.getElementById('text').value = results.rows.item(0).saying;
                                    $rootScope.my_state = true;
                                });
                            }
                        }
                    });
                });
            }
        }

        function inituser() {
            if ($window.sessionStorage.user == undefined) {
                $rootScope.my_state = false;
            } else {
                var user = $window.sessionStorage.user;
                ctrl.db.transaction(function(tx) {
                    tx.executeSql('select * from user where name= ?', [user], function(tx, results) {
                        document.getElementById('imgId').src = results.rows.item(0).myicon;
                        document.getElementById('text').value = results.rows.item(0).saying;
                    });
                });
                $rootScope.my_state = true;
            }
        }

        function logout() {
            delete $window.sessionStorage.user;
            $rootScope.my_state = false;
        }

        function openDialog(tip) {
            $rootScope.tip = "";
            $rootScope.tip = tip;
            ngDialog.open({
                template: '<div class="modal-body">{{tip}}</div>',
                plain: true,
                className: 'ngdialog-theme-default ngdialog-theme-tip',
                scope: $scope
            });
            updateCode();
        }

        function register() {
            ctrl.code = ctrl.code.toLowerCase();
            ctrl.inpcode = ctrl.inpcode.toLowerCase();
            if (!ctrl.add_user.username || !ctrl.add_user.password || !ctrl.add_user.private_que || !ctrl.add_user.private_ans || !ctrl.inpcode || !ctrl.sure_code) {
                openDialog('请确保信息的完整性！');
            } else {
                if (ctrl.sure_code != ctrl.add_user.password) {
                    openDialog('确认密码输入不一致！');
                } else if (ctrl.inpcode != ctrl.code) {
                    openDialog('验证码错误！');
                } else if (ctrl.sure_code == ctrl.add_user.password && ctrl.inpcode == ctrl.code) {
                    ctrl.db.transaction(function(tx) {
                        tx.executeSql('insert into user (name,password,question,answer,saying,myicon) VALUES (?, ?,?,?,?,?)', [ctrl.add_user.username, ctrl.add_user.password, ctrl.add_user.private_que, ctrl.add_user.private_ans, '', './imgs/myicon/myicon.png'], function() {
                            console.log('注册成功！');
                        });
                    });
                }
            }
        }

        function resetCode() {
            if (ctrl.code_user.username && ctrl.code_user.private_que && ctrl.code_user.private_ans && ctrl.code_user.password && ctrl.confim_code && ctrl.code_user.password == ctrl.confim_code) {
                ctrl.db.transaction(function(tx) {
                    tx.executeSql('select * from user where name= ? AND question=? AND answer=?', [ctrl.code_user.username, ctrl.code_user.private_que, ctrl.code_user.private_ans], function(tx, results) {
                        // console.log(results.rows.item.length);
                        if (results.rows.item.length == 0) {
                            openDialog('该用户保密问题或答案错误！');
                        } else {
                            ctrl.db.transaction(function(tx) {
                                tx.executeSql('UPDATE user SET password=? WHERE name=?', [ctrl.code_user.password, ctrl.code_user.username], function(tx, results) {
                                    openDialog('重置密码成功!');
                                });
                            });
                        }
                    });
                });

            } else {
                openDialog('请填写完整！');
            }
        }
    }
})();
(function() {
    angular.module('app').controller('MyDrawCtrl', MyDrawCtrl);

    // 全局控制器 
    /* ngInject */
    function MyDrawCtrl($rootScope, $window, BackService,$scope, $http, $state) {
        var ctrl = {};
        (function() {
            initMyDraw();
            BackService.init();
        })();

        function initMyDraw() {
            var token = $window.sessionStorage.token;
            if (token == undefined) {
                ctrl.my_pit = [];
            } else {
                $http
                    .get('http://192.168.0.195:3000/my_pit', {
                        params: {
                            "token": token
                        }
                    })
                    .success(function(data, status, headers, config) {
                        ctrl.my_pit = data;
                        console.log(data);
                    })
                    .error(function(data, status, headers, config) {});
            }
        }
        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('MyPitCtrl', MyPitCtrl);

    // 全局控制器 
    /* ngInject */
    function MyPitCtrl($rootScope, $window, BackService, $scope, $http, $state) {
        var ctrl = {
            my_pit: [],
            date: {},
            hdate: {},
            hisdate: [],
            musicShow: false,
            mShow: mShow
        };
        (function() {
            initHistory();
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function initHistory() {
            var db = openDatabase('history', '1.0', 'test db', 1024 * 1024);
            db.transaction(function(tx) {
                tx.executeSql('select * from history where name= ?', [$window.sessionStorage.user], function(tx, results) {
                    if (results.rows.length == 0) {
                        ctrl.my_pit[0] = "无收藏";
                    } else {
                        $scope.$apply(function() {
                            var date = [];
                            for (var i = 0; i < results.rows.length; i++) {
                                ctrl.my_pit.push(results.rows.item(i));
                                date[i] = ctrl.my_pit[i].date;
                                if (date.indexOf(date[i]) != i) {
                                    date.splice(i, 1);
                                }
                            }
                            for (var j = 0; j < date.length; j++) {
                                datePit(date[j])
                            }
                        });
                    }
                });
            });
        }

        function datePit(date) {
            var db = openDatabase('history', '1.0', 'test db', 1024 * 1024);
            db.transaction(function(tx) {
                tx.executeSql('select * from history where date= ?', [date], function(tx, results) {
                    $scope.$apply(function() {
                        var hdate = {};
                        hdate.date = date;
                        hdate.img = [];
                        for (var i = 0; i < results.rows.length; i++) {
                            hdate.img[i] = results.rows.item(i);
                        }
                        ctrl.hisdate.push(hdate);
                        console.log(ctrl.hisdate);
                    });
                });
            });
        }
        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('PaintBoardCtrl', PaintBoardCtrl);

    // 全局控制器 
    /* ngInject */
    function PaintBoardCtrl($rootScope, $scope, $state, $timeout,BackService, ngDialog, $window, $http) {
        var ctrl = {
            colorChoose: colorChoose,
            color: '#000',
            linewidth: 40,
            musicShow: false,
            mShow: mShow,
            type: 'pen',
            usePen: usePen,
            useEarser: useEarser,
            imgSave: imgSave,
            colorbox: ['#8827ff', '#027efa', '#ffdb11', '#66cc33', '#9e5e30', '#ff7238', '#d52113'],
            colorselect: '#ff7238'
        };
        (function() {
            BackService.init();
            var canvas = document.getElementById('create-con');
            $scope.context = canvas.getContext('2d');   
            listenToUser(canvas);         
            colorPick();
        })();
        return ctrl;

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function imgSave() {
            var canvas = document.getElementById('create-con');
            var ctx = canvas.getContext('2d');
            var imageData = canvas.toDataURL('image/png');
            var imgdata = imageData.substr(22);
            if ($window.sessionStorage.token == undefined) {
                alert('请先登录！');
                $state.go('main.my');
            } else {
                $http.post('http://192.168.0.195:3000/save_canvas', { "img": imgdata, "token": $window.sessionStorage.token })
                    .success(function(data) {
                        document.getElementById('img-save').style.background = '#78dfff';
                    })
                    .error(function(data) {
                        alert(status);
                    });
            }
        }

        function getPixelColor(canvas, x, y) {
            var thisContext = canvas.getContext("2d");
            var imageData = thisContext.getImageData(x, y, 1, 1);
            // 获取该点像素数据
            var pixel = imageData.data;
            var r = pixel[0];
            var g = pixel[1];
            var b = pixel[2];
            var a = 1;
            var rHex = r.toString(16);
            r < 16 && (rHex = "0" + rHex);
            var gHex = g.toString(16);
            g < 16 && (gHex = "0" + gHex);
            var bHex = b.toString(16);
            b < 16 && (bHex = "0" + bHex);
            var rgbaColor = "rgba(" + r + "," + g + "," + b + "," + a + ")";
            var rgbColor = "rgb(" + r + "," + g + "," + b + ")";
            var hexColor = "#" + rHex + gHex + bHex;
            return {
                rgba: rgbaColor,
                rgb: rgbColor,
                hex: hexColor,
                r: r,
                g: g,
                b: b,
                a: a
            };
        }

        function colorPick() {
            var colorpick = document.getElementById('color-gra');
            var colorhandle = document.getElementById('color-handle');
            var ctx = colorpick.getContext("2d");
            var my_gradient = ctx.createLinearGradient(0, 0, 0, 518);
            my_gradient.addColorStop(0, 'white');
            my_gradient.addColorStop(0.5, ctrl.colorselect);
            my_gradient.addColorStop(1, "black");
            ctx.fillStyle = my_gradient;
            ctx.fillRect(0, 0, colorpick.width, colorpick.height);

            var ifBool = false;
            var start = function(e) {
                e.stopPropagation();
                ifBool = true;
            }
            var move = function(e) {
                var x, y;
                if (ifBool) {
                    if (!e.touches) {
                        x = e.pageX;
                        y = e.pageY;

                    } else {
                        x = e.touches[0].clientX;
                        y = e.touches[0].clientY;
                    }
                    var lineDiv_top = getPosition(colorpick).top;
                    var minDiv_top = y - lineDiv_top;
                    if (minDiv_top >= colorpick.offsetHeight - 1) {
                        minDiv_top = colorpick.offsetHeight - 1;
                    }
                    if (minDiv_top < 0) {
                        minDiv_top = 0;
                    }
                    if (minDiv_top > 492) {
                        minDiv_top = 492;
                    }
                    colorhandle.style.top = minDiv_top + "px";

                    var colorData = getPixelColor(colorpick, 5, minDiv_top);
                    ctrl.colorselect = colorData.rgba;
                    // $("canvas").css("backgroundColor", ctrl.colorselect);
                    initStyle();
                }
            }
            var end = function(e) {
                ifBool = false;
            }
            colorhandle.addEventListener("touchstart", start);
            colorhandle.addEventListener("mousedown", start);
            window.addEventListener("touchmove", move);
            window.addEventListener("mousemove", move);

            window.addEventListener("touchend", end);
            window.addEventListener("mouseup", end);

            var getPosition = function(node) {

                var top = node.offsetTop;
                var left = node.offsetLeft;
                current = node.offsetParent;　　
                while (current != null) {　　
                    left += current.offsetLeft;　　
                    top += current.offsetTop;　　
                    current = current.offsetParent;　　
                    // console.log(top);
                }
                return {
                    "left": left,
                    "top": top
                };
            }
        }

        function initStyle() {
            $scope.context.strokeStyle = ctrl.colorselect;
            $scope.context.lineWidth = ctrl.linewidth;
            var penhead = document.getElementById('pen-head');
            penhead.style.fill = ctrl.colorselect;
        }

        function colorChoose(index) {
            var ol = document.getElementById('colorselect');
            var list = ol.getElementsByTagName('li');
            for (var i = 0; i < 7; i++) {
                list[i].style.border = "none";
            }
            list[index].style.border = "7px solid #fff";
            ctrl.colorselect = list[index].style.background;
            colorPick();
            initStyle();
        }

        function usePen() {
            ctrl.type = 'pen';
        }

        function useEarser() {
            ctrl.type = 'earser';
        }

        function drawLine(x1, y1, x2, y2) {
            $scope.context.beginPath();
            $scope.context.moveTo(x1, y1); // 起点
            $scope.context.lineTo(x2, y2); // 终点
            initStyle();
            $scope.context.stroke();
            $scope.context.closePath();
        }

        function autoSetCanvasSize(canvas) {
            setCanvasSize();

            window.onresize = function() {
                setCanvasSize();
            }

            function setCanvasSize() {
                var canvas = document.getElementById('create-con');               
                $scope.pageWidth = canvas.getBoundingClientRect().width;
                $scope.pageHeight = canvas.getBoundingClientRect().height;
                canvas.width = $scope.pageWidth;
                canvas.height = $scope.pageHeight;
            }
        }

        function listenToUser(canvas) {
            autoSetCanvasSize(canvas);   
            var using = false;
            var lastPoint = {
                x: undefined,
                y: undefined
            };
            if (document.body.ontouchstart !== undefined) {
                canvas.ontouchstart = function(e) {
                    var x = e.touches[0].clientX - canvas.getBoundingClientRect().left;
                    var y = e.touches[0].clientY - canvas.getBoundingClientRect().top;
                    using = true;
                    if (ctrl.type == "earser") {
                        $scope.context.clearRect(x - ctrl.linewidth, y - ctrl.linewidth, ctrl.linewidth * 2, ctrl.linewidth * 2);
                    } else {
                        lastPoint = {
                            "x": x,
                            "y": y
                        }
                    }
                };
                canvas.ontouchmove = function(e) {
                    var x = e.touches[0].clientX - canvas.getBoundingClientRect().left;
                    var y = e.touches[0].clientY - canvas.getBoundingClientRect().top;
                    if (!using) { return; }

                    if (ctrl.type == "earser") {
                        $scope.context.clearRect(x - ctrl.linewidth, y - ctrl.linewidth, ctrl.linewidth * 2, ctrl.linewidth * 2);
                    } else {
                        var newPoint = {
                            "x": x,
                            "y": y
                        }
                        drawLine(lastPoint.x, lastPoint.y, newPoint.x, newPoint.y);
                        lastPoint = newPoint;
                    }
                };
                canvas.ontouchend = function() {
                    using = false;
                };
            } else {
                // 非触屏设备
                canvas.onmousedown = function(e) {
                    var x = e.clientX - canvas.getBoundingClientRect().left;
                    var y = e.clientY - canvas.getBoundingClientRect().top;
                    using = true;
                    if (ctrl.type == "earser") {
                        $scope.context.clearRect(x - ctrl.linewidth, y - ctrl.linewidth, ctrl.linewidth * 2, ctrl.linewidth * 2);
                    } else {
                        lastPoint = {
                            "x": x,
                            "y": y
                        }
                    }
                };
                canvas.onmousemove = function(e) {
                    var x = e.clientX - canvas.getBoundingClientRect().left;
                    var y = e.clientY - canvas.getBoundingClientRect().top;

                    if (!using) { return; }

                    if (ctrl.type == "earser") {
                        $scope.context.clearRect(x - ctrl.linewidth, y - ctrl.linewidth, ctrl.linewidth * 2, ctrl.linewidth * 2);
                    } else {
                        var newPoint = {
                            "x": x,
                            "y": y
                        }
                        drawLine(lastPoint.x, lastPoint.y, newPoint.x, newPoint.y);
                        lastPoint = newPoint;
                    }

                };
                canvas.onmouseup = function(e) {
                    using = false;
                };
            }

        }
    }


})();
(function() {
    angular.module('app').controller('PaintCtrl', PaintCtrl);

    // 全局控制器 
    /* ngInject */
    function PaintCtrl($rootScope, $scope, $state,$timeout, ngDialog) {
    	var ctrl = {
        };
        (function() {
        })();
        return ctrl;
        
    }
})();
(function() {
    angular.module('app').controller('PitDetailCtrl', PitDetailCtrl);

    // 全局控制器 
    /* ngInject */
    function PitDetailCtrl($rootScope, $timeout, $webSql, $stateParams, $window, $scope, BackService, $http, $state, initImg, DirectService) {
        var ctrl = {
            pit: {},
            a: [],
            musicShow: false,
            iCollect: false,
            iAudio: false,
            pdetaildb: null,
            collectdb: null,
            pit_name: $stateParams.pit_name,
            pit_img: $stateParams.pit_img,
            pit: {},
            cpit: {},
            hpit: {},
            hdate: {},
            mShow: mShow,
            cShow: cShow,
            dragBack: dragBack,
            pitDrag: pitDrag,
            forGame: forGame,
            detailAudio: detailAudio
        };
        (function() {
            ctrl.pitname="星夜";
            ctrl.collectdb = openDatabase('collect', '1.0', 'test db', 1024 * 1024);
            ctrl.collectdb.transaction(function(tx) {
                tx.executeSql('CREATE TABLE IF NOT EXISTS collect (id unique,name,painting_name,painting_img,date)');
            });
            var myDate = new Date();
            var mytime = myDate.format("yyyy-MM-dd");
            ctrl.date = mytime;

            initDetailDB();
            // initMainDrawDB();
            BackService.init();
            init(ctrl.pitname);
            detailSlide();
            
            collectHeart();
            
        })();

        function initMainDrawDB() {
            if (!window.openDatabase) {
                alert('当前环境不支持websql');
            } else {
                ctrl.db = openDatabase('MainDraw', '1.0', 'test db', 1024 * 1024);
                ctrl.db.transaction(function(context) {
                    context.executeSql('CREATE TABLE IF NOT EXISTS maindraw (name unique,password,question,answer,saying,myicon)');
                    context.executeSql('INSERT INTO maindraw (name,password,question,answer,saying,myicon) VALUES ("chen", "123","wo","wo","I am chen","./imgs/myicon/myicon.png")');
                    context.executeSql('INSERT INTO maindraw (name,password,question,answer,saying,myicon) VALUES ("可", "123","wo","wo","I am 可","./imgs/myicon/myicon.png")');
                });
            };
        }


        function initDetailDB() {
            if (!window.openDatabase) {
                alert('当前环境不支持websql');
            } else {
                ctrl.pdetaildb = openDatabase('daily', '1.0', 'test db', 10 * 1024 * 1024);
                ctrl.pdetaildb.transaction(function(context) {
                    context.executeSql('CREATE TABLE IF NOT EXISTS detail (painting_name unique,painting_artist,painting_audio,painting_detail,dragpoint,dragimg,piturl)');
                    context.executeSql('INSERT INTO detail (painting_name,painting_artist,painting_audio,painting_detail,dragpoint,dragimg,piturl) VALUES ("星夜","梵高","./audio/music.mp3",\
                       " 欢迎来到梵高的《星夜》。a有人说：梵高的宇宙，可以在《星夜》中永恒。《星夜》这幅作品是以蓝色为主色调，画中景象是一个望出窗外的景象，以星光中的夜空为主要绘画对象，最近处是一棵柏树。你们觉得油画中的主色调蓝色代表什么感觉呢？a在梵高的《星夜》中他运用歪曲的长线与破碎的短线的线条绘画风格，使得画面呈现出一种炫目的奇幻景象。躁动的夜空、星星、月亮，不安的柏树与平静的村庄、横向的山脉。你们是否感受到画家躁动不安的情感和迷幻的意象世界？......a《星夜》现存于纽约现代艺术馆。",\
                       "0,167,523,1010)915,1048,271,94)684,663,356,323)0,1250,352,292)83,1074,155,155)425,129,105,121)17,295,134,131)410,0,89,86)246,462,96,96)445,435,222,222",\
                       "tree.png,house1.png,house2.png,start1.png,start2.png,start3.png,start4.png,start5.png,start6.png,start7.png","./imgs/dailypit/xingye1.jpg")');
                });
            };
        }

        function init(pit_name) {
            ctrl.pdetaildb.transaction(function(tx) {
                tx.executeSql('select * from detail where painting_name= ?', [pit_name], function(tx, results) {
                    $scope.$apply(function() {
                        var pit = {};
                        pit = results.rows.item(0);
                        pit.dragItem = [];
                        pit.a = pit.painting_detail.split('a');
                        pit.dragpath = pit.dragimg.split(',');
                        pit.dragpit = [{}, {}];
                        for (var j = 0; j < pit.dragpath.length; j++) {
                            pit.dragItem[j] = pit.dragpath[j].split('.')[0];
                            pit.dragpath[j] = './imgs/dailypit/' + pit.dragpath[j];

                            var obj = {};
                            obj.name = pit.dragItem[j];
                            obj.path = pit.dragpath[j];
                            obj.top = parseInt(pit.dragpoint.split(')')[j].split(',')[0]);
                            obj.left = parseInt(pit.dragpoint.split(')')[j].split(',')[1]);
                            obj.width = parseInt(pit.dragpoint.split(')')[j].split(',')[2]);
                            obj.height = parseInt(pit.dragpoint.split(')')[j].split(',')[3]);
                            pit.dragpit[j] = obj;
                        }
                        delete pit.dragItem;
                        delete pit.dragimg;
                        delete pit.dragpath;
                        delete pit.dragpoint;
                        console.log(pit);
                        ctrl.pit = pit;
                        historyAdd();
                        // var audio = document.getElementById('detail');
                        // var source = audio.getElementsByTagName('source');
                        // source[0].src = ctrl.pit.painting_audio;                        
                        pitDrag();
                    });
                });
            });
        }

        function detailAudio() {
            ctrl.iAudio = !ctrl.iAudio;
            var audio = document.getElementById('detail');
            if (ctrl.iAudio) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }

        function collectHeart() {
            if ($window.sessionStorage.user == undefined) {
                ctrl.iCollect = false;
            } else {
                var id = [$window.sessionStorage.user, ctrl.pit_name].join('.');
                ctrl.collectdb.transaction(function(tx) {
                    tx.executeSql('select * from collect where id= ?', [id], function(tx, results) {
                        if (results.rows.length == 0) {
                            ctrl.iCollect = false;
                            console.log('false');
                        } else {
                            $scope.$apply(function() {
                                ctrl.iCollect = true;
                                console.log('true');
                            });

                        }
                    });
                });
            }
        }

        function historyAdd() {
            if($window.sessionStorage.user!=undefined){
                var id=[$window.sessionStorage.user,ctrl.date,ctrl.pit_name].join('.');
                var db;
                db = openDatabase('history', '1.0', 'test db', 1024 * 1024);
                db.transaction(function(tx) {
                    tx.executeSql('CREATE TABLE IF NOT EXISTS history (id unique,name,painting_name,painting_img,date)');
                });
                db.transaction(function(tx) {
                    tx.executeSql('INSERT INTO history (id,name,painting_name,painting_img,date) VALUES (?,?,?,?,?)', [id,$window.sessionStorage.user,ctrl.pit_name,ctrl.pit_img,ctrl.date], function(tx, results) {
                        console.log('记录成功！');
                    });
                });
            }
        }

        function cShow() {
            var id = [$window.sessionStorage.user, ctrl.pit_name].join('.');
            if (!ctrl.iCollect) {
                if ($window.sessionStorage.user == undefined) {
                    alert('请先登录！');
                    $timeout(function() {
                        $state.go('main.my');
                    }, 100);
                } else {
                    ctrl.collectdb.transaction(function(tx) {
                        tx.executeSql('INSERT INTO collect (id,name,painting_img,painting_name,date) VALUES (?,?,?,?,?)', [id,$window.sessionStorage.user,ctrl.pit_img, ctrl.pit_name,ctrl.date], function(tx, results) {
                            $scope.$apply(function() {
                                ctrl.iCollect = true;
                                console.log('收藏成功！');
                            });
                        });
                    });
                }
            } else {
                ctrl.collectdb.transaction(function(tx) {
                    tx.executeSql('delete from collect where id=?', [id], function(tx, results) {
                        $scope.$apply(function() {
                            ctrl.iCollect = false;
                            console.log('取消收藏成功！');
                        });
                    });
                });

            }
        }

        function detailSlide() {
            var startx, starty;

            var start = function(e) {
                if (!e.touches) {
                    startx = e.pageX;
                    starty = e.pageY;

                } else {
                    startx = e.touches[0].pageX;
                    starty = e.touches[0].pageY;
                }
            }
            var end = function(e) {
                var endx, endy;
                if (!e.touches) {
                    endx = e.pageX;
                    endy = e.pageY;

                } else {
                    endx = e.changedTouches[0].pageX;
                    endy = e.changedTouches[0].pageY;
                }

                var direction = DirectService.getDirection(startx, starty, endx, endy);
                switch (direction) {
                    case 1:
                        $("#pd-detail").slideDown();
                        var pd = document.getElementById("pdetail_box");
                        pd.scrollTop = pd.scrollHeight;
                        break;
                    default:
                }
            }
            document.addEventListener("touchstart", start);
            document.addEventListener("mousedown", start);
            document.addEventListener("touchend", end);
            document.addEventListener("mouseup", end);
        }

        function dragBack() {
            // pitDrag();
        }

        function forGame() {
            $state.go('main.game');
        }

        function drawImg(X, Y) {
            var ctx = document.getElementById("p_detail_drag").getContext("2d");
            var img = document.getElementById("drag_img");
            ctx.clearRect(0, 0, 1600, 1010);
            ctx.beginPath();
            // img.onload = function() {
            ctx.drawImage(img, X, Y, 200, 300);
            // }
            ctx.closePath();
            ctx.stroke();
        }

        function drag(drag) {
            var X = 0;
            var Y = 0;
            // drag.setAttribute("class", "level-top");
            var moveFlag = false;
            drag.ontouchstart = function(e) {
                drag.setAttribute("class", "level-top");
                moveFlag = true;
                var clickEvent = window.event || e;
                var mwidth = clickEvent.clientX - drag.offsetLeft;
                var mheight = clickEvent.clientY - drag.offsetTop;
                document.ontouchmove = function(e) {
                    var moveEvent = window.event || e;
                    if (moveFlag) {
                        drag.style.left = moveEvent.clientX - mwidth + "px";
                        drag.style.top = moveEvent.clientY - mheight + "px";

                        X = moveEvent.clientX - mwidth;
                        Y = moveEvent.clientY - mheight;

                        if (moveEvent.clientX <= mwidth) {
                            drag.style.left = 0 + "px";
                            X = 0;
                        }
                        if (parseInt(drag.style.left) + drag.offsetWidth >= 1605) {
                            drag.style.left = 1605 - drag.offsetWidth + "px";
                            X = 1605 - drag.offsetWidth;
                        }
                        if (moveEvent.clientY <= mheight) {
                            drag.style.top = 0 + "px";
                            Y = 0;
                        }
                        if (parseInt(drag.style.top) + drag.offsetHeight >= 1010) {
                            drag.style.top = 1010 - drag.offsetHeight + "px";
                            Y = 1010 - drag.offsetHeight;
                        }
                        // drawImg(X, Y);
                        drag.ontouched = function() {
                            moveFlag = false;
                        }
                    }
                }
            };
            drag.onmousedown = function(e) {
                moveFlag = true;
                var clickEvent = window.event || e;
                var mwidth = clickEvent.clientX - drag.offsetLeft;
                var mheight = clickEvent.clientY - drag.offsetTop;
                document.onmousemove = function(e) {
                    var moveEvent = window.event || e;
                    if (moveFlag) {
                        drag.style.left = moveEvent.clientX - mwidth + "px";
                        drag.style.top = moveEvent.clientY - mheight + "px";

                        X = moveEvent.clientX - mwidth;
                        Y = moveEvent.clientY - mheight;

                        if (moveEvent.clientX <= mwidth) {
                            drag.style.left = 0 + "px";
                            X = 0;
                        }
                        if (parseInt(drag.style.left) + drag.offsetWidth >= 1605) {
                            drag.style.left = 1605 - drag.offsetWidth + "px";
                            X = 1605 - drag.offsetWidth;
                        }
                        if (moveEvent.clientY <= mheight) {
                            drag.style.top = 0 + "px";
                            Y = 0;
                        }
                        if (parseInt(drag.style.top) + drag.offsetHeight >= 1010) {
                            drag.style.top = 1010 - drag.offsetHeight + "px";
                            Y = 1010 - drag.offsetHeight;
                        }
                        // drawImg(X, Y);
                        drag.onmouseup = function() {
                            moveFlag = false;
                        }
                    }
                }
            };
        }

        function createDrag() {
            // console.log(ctrl.piturl);
            var p_bg = document.getElementById("p_bg");
            p_bg.style.backgroundImage = "url(" + ctrl.pit.piturl + ")";
            for (var i = 0; i < ctrl.pit.dragpit.length; i++) {
                var drag_box = document.createElement("div");
                drag_box.setAttribute("class", "can-drag");
                drag_box.setAttribute("id", ctrl.pit.dragpit[i].name);
                p_bg.appendChild(drag_box);
                drag(document.getElementById(ctrl.pit.dragpit[i].name));
            }
        }

        function pitDrag() {
            createDrag();
            for (var i = 0; i < ctrl.pit.dragpit.length; i++) {
                (function(i) {
                    var drag_box = document.getElementById(ctrl.pit.dragpit[i].name);
                    drag_box.style.top = ctrl.pit.dragpit[i].top + 'px';
                    drag_box.style.left = ctrl.pit.dragpit[i].left + 'px';
                    drag_box.style.width = ctrl.pit.dragpit[i].width + 'px';
                    drag_box.style.height = ctrl.pit.dragpit[i].height + 'px';
                    drag_box.style.backgroundImage = "url(" + ctrl.pit.dragpit[i].path + ")";
                })(i);
            }
        }
        // }
        return ctrl;

    }
})();
(function() {
    angular.module('app').controller('PuzzleCtrl', PuzzleCtrl);

    // 全局控制器 
    /* ngInject */
    function PuzzleCtrl($rootScope, $scope, $state, $http, $timeout, ngDialog,BackService) {
        var ctrl = {
            musicShow: false,
            mShow: mShow
        };
        (function() {
        	$rootScope.tipShow = true;
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }
        
        return ctrl;
    }
})();
(function() {
    angular.module('app').controller('QuestionCtrl', QuestionCtrl);

    // 全局控制器 
    /* ngInject */
    function QuestionCtrl($rootScope, $stateParams, $window,$timeout,ngDialog,BackService, $scope, $http, $state) {
        var ctrl = {
            musicShow: false,
            mShow: mShow,
            qArr: [],
            question: [{
                id: 0,
                q: "小朋友们你们知道《星夜》中最近处的物体是什么吗？",
                aTrue: 0,
                a: ["松树", "柏树", "木棉树"]
            }, {
                id: 1,
                q: "rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr",
                aTrue: 2,
                a: ["ssssssss", "xxxxxxxxxxx", "eeeeeeee"]
            }],
            qshow: {},
            selectAns: selectAns,
            close:close
        };
        (function() {
            ctrl.qshow = ctrl.question[0];
            BackService.init();
        })();

        function mShow() {
            ctrl.musicShow = !ctrl.musicShow;
            var audio = document.getElementById('mp3Btn');
            if (ctrl.musicShow) {
                audio.play();
            } else {
                audio.pause();
            }
        }
        function close(){
            ngDialog.closeAll();
        }
        function selectAns(index, q) {
            var list = document.getElementsByTagName('i');
            if (index != q.aTrue) {
                for (var i = 0; i < 3; i++) {
                    list[i].style.background = "#fff";
                }
                list[index].style.background = "#f00";
            } else {
                for (var i = 0; i < 3; i++) {
                    list[i].style.background = "#fff";
                }
                list[index].style.background = "#0dc6ff";
            }
            $timeout(function() {
                if (q.id < ctrl.question.length - 1 && index == q.aTrue) {
                    ctrl.qArr[q.id] = true;
                    var qid = q.id + 1;
                    ctrl.qshow = ctrl.question[qid];
                }
                else if(q.id == ctrl.question.length-1&&index == q.aTrue){
                    ngDialog.open({
                            template: 'qa_finsh.html',
                            className: 'ngdialog-theme-default ngdialog-theme-custom',
                            scope: $scope
                    });
                    ctrl.qshow = ctrl.question[0];
                }
            }, 800);
        }
        return ctrl;

    }
})();
angular.module('app')
    .directive('baiduMap', baiduMap);

baiduMap.$inject = ['$window'];

function baiduMap($window) {
    return {
            restrict: 'A',
            scope: {
                mapReady: '&'
            },
            link: function (scope, element, attrs) {
                $window.baiduMapLoaded = function () {
                    var map = new BMap.Map(element[0]);
                    scope.mapReady({map: map});
                };
                var script = document.createElement("script");
                script.src = 'http://api.map.baidu.com/api?v=2.0&ak=' + attrs.baiduMap + '&callback=baiduMapLoaded';
                document.body.appendChild(script);
            }
        };  
}
angular.module('app').factory('BackService', BackService);

/* ngInject */
function BackService() {

    function init() {
        var back = document.getElementById('back');
        if (document.body.ontouchstart !== undefined) {
        	back.ontouchstart = function() {
            	history.back();
        	}
        }else{
			back.onclick = function() {
            	history.back();
        	}        	
        }
    }
    return {
        init: init
    };

}
angular.module('app').factory('DirectService', DirectService);

/* ngInject */
function DirectService($rootScope, $window, $http) {

    function getDirection(startx, starty, endx, endy) {
        var angx = endx - startx;
        var angy = endy - starty;
        var result = 0;

        //如果滑动距离太短  
        if (Math.abs(angx) < 20 && Math.abs(angy) < 20) {
            return result;
        }

        function getAngle(angx, angy) {
            return Math.atan2(angy, angx) * 180 / Math.PI;
        };
        
        var angle = getAngle(angx, angy);
        if ((angle >= 135 && angle <= 180) || (angle >= -180 && angle < -135)) {
            result = 3;
        } else if (angle >= -45 && angle <= 45) {
            result = 4;
        }else if (angle >= -135 && angle <= -45) {
            result = 1;
        } else if (angle > 45 && angle < 135) {
            result = 2;
        } 

        return result;
    }
    return {
        getDirection: getDirection
    };
}
angular.module('app').factory('initImg', initImg);

/* ngInject */
function initImg($rootScope, $window, $timeout, $http) {

    function init(pit_name) {

        $http.get('http://192.168.0.195:3000/pit_detail', { params: { 'pitname': pit_name } })
            .success(function(data, status, headers, config) {
                var pit = {};
                pit = data;
                pit.a = pit.painting_detail.split('a');
                pit.dragpit = [{}, {}];
                for (var i = 0; i < pit.dragItem.length; i++) {
                    var obj = {};
                    obj.url = pit.dragimg.split('@')[i];
                    obj.name = pit.dragItem[i];
                    obj.top = parseInt(pit.dragpoint.split(')')[i].split(',')[0]);
                    obj.left = parseInt(pit.dragpoint.split(')')[i].split(',')[1]);
                    obj.width = parseInt(pit.dragpoint.split(')')[i].split(',')[2]);
                    obj.height = parseInt(pit.dragpoint.split(')')[i].split(',')[3]);
                    pit.dragpit[i] = obj;
                }
                return pit;
            })
            .error(function(data, status, headers, config) {return '获取失败！'});
            
    }

    return {
        init: init
    };
}
angular.module('app').factory('initService', initService);

/* ngInject */
function initService($rootScope, $window, $http) {

    function init() {
        var token=$window.sessionStorage.token;
        if (token==undefined) {
            $rootScope.isAuthenticated = false;
            $rootScope.welcome = '';
            $rootScope.avatar = './imgs/common/myicon.png';
        } else {
            $rootScope.isAuthenticated = true;
            $rootScope.welcome = 'Welcome ';
            $http.post('http://192.168.0.195:3000/myicon', { "token": token })
                .success(function(data, status, headers, config) {
                    $rootScope.avatar=data;
                    $window.sessionStorage.myicon=data;
                }).error(function(data, status, headers, config) {});
        }
    }
    return {
        init: init
    };
}
angular.module('app').factory('tipDialogService', tipDialogService);

/* ngInject */
function tipDialogService($rootScope,$scope,$window, $http,ngDialog) {

    function openDialog(tip) {
        ngDialog.open({
            template: '<span class="modal-body">{{tip}}</span>',
            plain: true,
            className: 'ngdialog-theme-default ngdialog-theme-tip',
            scope: $scope
        });
    }
    return {
        openDialog: openDialog
    };
}

angular.module('app').factory('UserService', UserService);

/* ngInject */
function UserService($rootScope, $window, ngDialog, $timeout, $http) {
    var db = null;

    function init() {
        if (!window.openDatabase) {
            alert('当前环境不支持websql');
        } else {
            db = openDatabase('users', '1.0', 'test db', 1024 * 1024);
            db.transaction(function(context) {
                context.executeSql('CREATE TABLE IF NOT EXISTS user (name unique,password,question,answer,saying,myicon)');
                context.executeSql('INSERT INTO user (name,password,question,answer,saying,myicon) VALUES ("chen", "123","wo","wo","I am chen","./imgs/myicon/myicon.png")');
                context.executeSql('INSERT INTO user (name,password,question,answer,saying,myicon) VALUES ("可", "123","wo","wo","I am 可","./imgs/myicon/myicon.png")');
            });
        };
    }

    function openDialog(tip) {
        $rootScope.tip = "";
        $rootScope.tip = tip;
        ngDialog.open({
            template: '<div class="modal-body">{{tip}}</div>',
            plain: true,
            className: 'ngdialog-theme-default ngdialog-theme-tip'
        });
    }

    function loginDB(user) {
        init();
        var data = [];
        db.executeSql('select * from user where name= ?', [user.username], function(tx, result) {
            if (result.rows.length == 0) {
                // login('0');
                return '0';
            } else {
                if (result.rows.item(0).password == user.password) {
                    // login(result.rows.item(0));
                    return '0';
                } else {
                    // login('1');
                    return '0';
                }
            }
        });
        // return data;
    }

    function login(state) {
        var my_state;
        if (state == '0') {
            openDialog('不存在该用户，请先注册！');
        } else if (state == '1') {
            openDialog('密码错误！');
        } else {
            $rootScope.$emit('loginstate', state);
        }
    }

    function register() {

    }

    return {
        init: init,
        loginDB: loginDB,
        register: register
    };
}